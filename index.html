<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drain Tracker PWA</title>
    <meta name="description" content="A PWA for tracking medical drain output.">
    <meta name="theme-color" content="#317EFB"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the custom modal */
        .modal {
            display: none;
            align-items: center;
            justify-content: center;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
        }
    </style>
    <script>
        // On page load or when changing themes, best to add inline in `head` to avoid FOUC (flash of unstyled content)
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div class="container mx-auto p-4 md:p-6 max-w-4xl">
        <header class="relative text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-600 dark:text-blue-500">Drain Tracker</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">A simple PWA to monitor drain output.</p>
            
            <!-- Dark Mode Toggle -->
            <div class="absolute top-0 right-0">
                <button id="dark-mode-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900">
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 5a7 7 0 100 14 7 7 0 000-14z" />
                    </svg>
                </button>
            </div>
        </header>

        <main class="space-y-8">
            <!-- Drain Management Section -->
            <section id="drain-management" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b dark:border-gray-700 pb-2">Manage Drains</h2>
                <form id="add-drain-form" class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="drain-name-input" placeholder="Enter new drain name (e.g., 'JP Drain Left')" class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700" required>
                    <button type="submit" class="bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 transition duration-300 shadow">Add Drain</button>
                </form>
                <div class="mt-6">
                    <h3 class="text-xl font-semibold mb-2">Your Drains:</h3>
                    <ul id="drains-list" class="space-y-2">
                        <!-- Drains will be dynamically inserted here -->
                    </ul>
                </div>
            </section>

            <!-- Log Drainage Section -->
            <section id="log-drainage" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b dark:border-gray-700 pb-2">Log Drainage Output</h2>
                <form id="log-output-form" class="space-y-4">
                    <div>
                        <label for="drain-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Drain:</label>
                        <select id="drain-select" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700" required>
                            <!-- Options will be dynamically inserted here -->
                        </select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="output-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Output (ml):</label>
                            <input type="number" id="output-amount" min="0" step="1" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700" required>
                        </div>
                        <div>
                            <label for="output-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date & Time:</label>
                            <input type="datetime-local" id="output-date" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700" required>
                        </div>
                    </div>
                    <div>
                         <label for="output-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes (optional):</label>
                         <textarea id="output-notes" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700" placeholder="e.g., color, consistency"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 transition duration-300 shadow">Log Output</button>
                </form>
            </section>

            <!-- Daily Summary Section -->
            <section id="summary-display" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b dark:border-gray-700 pb-2">Daily Summary</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead id="summary-table-head" class="bg-gray-50 dark:bg-gray-700">
                            <!-- Header will be dynamically generated -->
                        </thead>
                        <tbody id="summary-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Summary rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Detailed Log History Section -->
            <section id="data-display" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b dark:border-gray-700 pb-2">Detailed Log History</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Drain</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date & Time</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Output (ml)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Notes</th>
                                <th scope="col" class="relative px-6 py-3">
                                    <span class="sr-only">Delete</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="log-history-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Log entries will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Data Management Section -->
            <section id="data-management" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b dark:border-gray-700 pb-2">Data Management</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="export-data-btn" class="flex-1 bg-purple-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-600 transition duration-300 shadow">Export Data (JSON)</button>
                    <label for="import-data-input" class="flex-1 bg-yellow-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-yellow-600 transition duration-300 shadow text-center cursor-pointer">
                        Import Data (JSON)
                        <input type="file" id="import-data-input" class="hidden" accept=".json">
                    </label>
                </div>
            </section>
        </main>

        <footer class="text-center mt-8 text-gray-500 dark:text-gray-400 text-sm">
            <p>Drain Tracker PWA &copy; 2024</p>
        </footer>
    </div>
    
    <!-- Custom Modal for Messages -->
    <div id="message-modal" class="modal">
        <div class="modal-content text-center bg-white dark:bg-gray-800 dark:border-gray-600">
            <p id="modal-message" class="text-lg mb-4"></p>
            <button id="modal-close-btn" class="bg-blue-500 text-white font-semibold py-2 px-8 rounded-lg hover:bg-blue-600 transition duration-300">OK</button>
        </div>
    </div>


    <script>
    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }

    // --- Application Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Element References ---
        const addDrainForm = document.getElementById('add-drain-form');
        const drainNameInput = document.getElementById('drain-name-input');
        const drainsList = document.getElementById('drains-list');
        const drainSelect = document.getElementById('drain-select');
        
        const logOutputForm = document.getElementById('log-output-form');
        const outputAmountInput = document.getElementById('output-amount');
        const outputDateInput = document.getElementById('output-date');
        const outputNotesInput = document.getElementById('output-notes');
        const logHistoryBody = document.getElementById('log-history-body');

        const summaryTableHead = document.getElementById('summary-table-head');
        const summaryTableBody = document.getElementById('summary-table-body');

        const exportBtn = document.getElementById('export-data-btn');
        const importInput = document.getElementById('import-data-input');

        const modal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const darkModeToggle = document.getElementById('dark-mode-toggle');

        // --- Data Store ---
        let appData = {
            drains: [],
            logs: []
        };

        // --- Utility Functions ---
        const showMessage = (message) => {
            modalMessage.textContent = message;
            modal.style.display = 'flex';
        };

        modalCloseBtn.onclick = () => {
            modal.style.display = 'none';
        };
        
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        const saveData = () => {
            localStorage.setItem('drainTrackerData', JSON.stringify(appData));
        };

        const loadData = () => {
            const data = localStorage.getItem('drainTrackerData');
            if (data) {
                appData = JSON.parse(data);
            }
        };

        const generateId = () => `id_${new Date().getTime()}_${Math.random().toString(36).substr(2, 9)}`;

        // --- Render Functions ---
        const renderDrains = () => {
            drainsList.innerHTML = '';
            drainSelect.innerHTML = '<option value="" disabled selected>Select a drain</option>';
            
            if (appData.drains.length === 0) {
                drainsList.innerHTML = '<li class="text-gray-500 dark:text-gray-400">No drains added yet.</li>';
            }

            appData.drains.forEach(drain => {
                // Add to list
                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg';
                listItem.innerHTML = `
                    <span class="font-medium">${drain.name}</span>
                    <button data-id="${drain.id}" class="delete-drain-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                `;
                drainsList.appendChild(listItem);

                // Add to select dropdown
                const option = document.createElement('option');
                option.value = drain.id;
                option.textContent = drain.name;
                drainSelect.appendChild(option);
            });
        };

        const renderLogs = () => {
            logHistoryBody.innerHTML = '';
            
            if (appData.logs.length === 0) {
                logHistoryBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">No logs recorded yet.</td></tr>';
                return;
            }

            // Sort logs by date, most recent first
            const sortedLogs = [...appData.logs].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedLogs.forEach(log => {
                const drain = appData.drains.find(d => d.id === log.drainId);
                const drainName = drain ? drain.name : 'Unknown Drain';
                const formattedDate = new Date(log.date).toLocaleString();

                const row = document.createElement('tr');
                row.className = "bg-white dark:bg-gray-800";
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${drainName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${log.amount.toFixed(1)} ml</td>
                    <td class="px-6 py-4 whitespace-normal">${log.notes || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${log.id}" class="delete-log-btn text-red-500 hover:text-red-700">Delete</button>
                    </td>
                `;
                logHistoryBody.appendChild(row);
            });
        };

        const renderSummaryTable = () => {
            summaryTableHead.innerHTML = '';
            summaryTableBody.innerHTML = '';

            if (appData.drains.length === 0) {
                const placeholderRow = `<tr><td colspan="1" class="text-center py-4 text-gray-500 dark:text-gray-400">Add a drain to see the summary.</td></tr>`;
                summaryTableHead.innerHTML = '<tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th></tr>';
                summaryTableBody.innerHTML = placeholderRow;
                return;
            }

            // --- Create Header ---
            const headerRow = document.createElement('tr');
            let headerHTML = '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>';
            appData.drains.forEach(drain => {
                headerHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${drain.name}</th>`;
            });
            headerHTML += '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider font-bold">Daily Total</th>';
            headerRow.innerHTML = headerHTML;
            summaryTableHead.appendChild(headerRow);

            if (appData.logs.length === 0) {
                const placeholderRow = `<tr><td colspan="${appData.drains.length + 2}" class="text-center py-4 text-gray-500 dark:text-gray-400">No logs recorded yet.</td></tr>`;
                summaryTableBody.innerHTML = placeholderRow;
                return;
            }

            // --- Process Data ---
            const dailySummaries = appData.logs.reduce((acc, log) => {
                const dateKey = new Date(log.date).toISOString().split('T')[0];
                if (!acc[dateKey]) {
                    acc[dateKey] = {};
                }
                acc[dateKey][log.drainId] = (acc[dateKey][log.drainId] || 0) + log.amount;
                return acc;
            }, {});

            // --- Create Body Rows ---
            const sortedDates = Object.keys(dailySummaries).sort((a, b) => new Date(b) - new Date(a));

            sortedDates.forEach(date => {
                const row = document.createElement('tr');
                row.className = "bg-white dark:bg-gray-800";
                let dailyTotal = 0;
                let rowHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium">${date}</td>`;

                appData.drains.forEach(drain => {
                    const amount = dailySummaries[date][drain.id] || 0;
                    rowHTML += `<td class="px-6 py-4 whitespace-nowrap">${amount.toFixed(1)} ml</td>`;
                    dailyTotal += amount;
                });

                rowHTML += `<td class="px-6 py-4 whitespace-nowrap font-bold">${dailyTotal.toFixed(1)} ml</td>`;
                row.innerHTML = rowHTML;
                summaryTableBody.appendChild(row);
            });
        };
        
        const renderAll = () => {
            renderDrains();
            renderLogs();
            renderSummaryTable();
        };

        // --- Event Handlers ---
        darkModeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        addDrainForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const drainName = drainNameInput.value.trim();
            if (drainName) {
                const newDrain = {
                    id: generateId(),
                    name: drainName
                };
                appData.drains.push(newDrain);
                saveData();
                renderAll();
                drainNameInput.value = '';
                showMessage(`Drain "${drainName}" added successfully!`);
            }
        });

        drainsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-drain-btn')) {
                const drainId = e.target.getAttribute('data-id');
                const drainToDelete = appData.drains.find(d => d.id === drainId);
                
                if (confirm(`Are you sure you want to delete the drain "${drainToDelete.name}"? This will also delete all associated logs.`)) {
                    appData.drains = appData.drains.filter(d => d.id !== drainId);
                    appData.logs = appData.logs.filter(log => log.drainId !== drainId);
                    saveData();
                    renderAll();
                    showMessage('Drain and its logs have been deleted.');
                }
            }
        });

        logOutputForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const drainId = drainSelect.value;
            const amount = outputAmountInput.value;
            const date = outputDateInput.value;
            const notes = outputNotesInput.value.trim();

            if (drainId && amount && date) {
                const newLog = {
                    id: generateId(),
                    drainId,
                    amount: parseFloat(amount),
                    date,
                    notes
                };
                appData.logs.push(newLog);
                saveData();
                renderAll();
                logOutputForm.reset();
                outputDateInput.value = new Date().toISOString().slice(0, 16);
                showMessage('Drainage output logged successfully.');
            } else {
                showMessage('Please fill in all required fields.');
            }
        });
        
        logHistoryBody.addEventListener('click', e => {
            if(e.target.classList.contains('delete-log-btn')) {
                const logId = e.target.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this log entry?')) {
                    appData.logs = appData.logs.filter(log => log.id !== logId);
                    saveData();
                    renderAll();
                    showMessage('Log entry deleted.');
                }
            }
        });

        exportBtn.addEventListener('click', () => {
            if (appData.drains.length === 0 && appData.logs.length === 0) {
                showMessage('No data to export.');
                return;
            }
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `drain-tracker-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showMessage('Data exported successfully.');
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (importedData && Array.isArray(importedData.drains) && Array.isArray(importedData.logs)) {
                        if (confirm('Are you sure you want to import this data? This will overwrite all current data.')) {
                            appData = importedData;
                            saveData();
                            renderAll();
                            showMessage('Data imported successfully!');
                        }
                    } else {
                        throw new Error('Invalid file format.');
                    }
                } catch (error) {
                    showMessage(`Error importing file: ${error.message}`);
                } finally {
                    importInput.value = '';
                }
            };
            reader.readAsText(file);
        });

        // --- Initial Load ---
        loadData();
        renderAll();
        outputDateInput.value = new Date().toISOString().slice(0, 16);
    });
    </script>
</body>
</html>
